# Kubernetes Deployment Automation - Industry Best Practices

This repository implements **Infrastructure as Code (IaC)** best practices for deploying a production-ready Kubernetes cluster on AWS.

## Architecture

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Terraform     ‚îÇ  ‚Üí Provisions AWS infrastructure (VPC, EC2, ASG)
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ (auto-generates)
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Ansible Inventory‚îÇ  ‚Üí Dynamic inventory with IPs from Terraform
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Kubespray     ‚îÇ  ‚Üí Deploys Kubernetes cluster
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## Why This Approach? (Industry Standards)

### ‚úÖ **Separation of Concerns**

- **Terraform**: Infrastructure provisioning (what AWS resources exist)
- **Ansible/Kubespray**: Configuration management (how those resources are configured)

### ‚úÖ **Dynamic Inventory Generation**

- **Problem**: Hardcoded IPs become stale when infrastructure changes
- **Solution**: Auto-generate inventory from Terraform state
- **Benefits**:
  - Single source of truth (Terraform state)
  - No manual IP copying
  - Idempotent and repeatable

### ‚úÖ **Public vs Private IPs**

- **`ansible_host`**: Public IP (for Ansible to connect via SSH)
- **`ip` / `access_ip`**: Private IP (for internal K8s pod communication)
- **Why**: Kubernetes nodes communicate over private network for security and performance

### ‚úÖ **Auto Scaling Group (ASG) Support**

- Infrastructure scales up/down automatically
- Inventory regenerates when instances change
- Maintains cluster state consistency

## Project Structure

```
salon-k8s-infra/
‚îú‚îÄ‚îÄ terraform/
‚îÇ   ‚îú‚îÄ‚îÄ *.tf                    # Infrastructure definitions
‚îÇ   ‚îú‚îÄ‚îÄ generate_inventory.sh  # Auto-generates Kubespray inventory
‚îÇ   ‚îî‚îÄ‚îÄ terraform.tfstate       # Current infrastructure state
‚îÇ
‚îú‚îÄ‚îÄ kubespray/
‚îÇ   ‚îú‚îÄ‚îÄ inventory/mycluster/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ hosts.yaml         # Auto-generated inventory
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ group_vars/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ all.yml        # K8s cluster configuration
‚îÇ   ‚îî‚îÄ‚îÄ cluster.yml            # Kubespray deployment playbook
‚îÇ
‚îú‚îÄ‚îÄ deploy-k8s.sh              # Full deployment automation
‚îî‚îÄ‚îÄ refresh-inventory.sh       # Refresh inventory only
```

## Workflows

### Full Deployment (Infrastructure + Kubernetes)

```bash
./deploy-k8s.sh
```

This script:

1. Runs Terraform to create AWS infrastructure
2. Auto-generates Ansible inventory from Terraform outputs
3. Tests SSH connectivity to all nodes
4. Deploys Kubernetes using Kubespray

### Refresh Inventory Only

When infrastructure already exists but IPs changed:

```bash
./refresh-inventory.sh
```

### Manual Step-by-Step

```bash
# 1. Deploy infrastructure
cd terraform
terraform init
terraform plan
terraform apply

# 2. Generate inventory (automatic via null_resource, or manual)
bash generate_inventory.sh

# 3. Verify connectivity
cd ../kubespray
ansible all -i inventory/mycluster/hosts.yaml -m ping

# 4. Deploy Kubernetes
ansible-playbook -i inventory/mycluster/hosts.yaml cluster.yml -b
```

## Prerequisites

1. **AWS Credentials** configured (`aws configure`)
2. **SSH Key** placed at `~/.ssh/salon-key.pem` with proper permissions:
   ```bash
   chmod 400 ~/.ssh/salon-key.pem
   ```
   Note: The private key is generated by Terraform in `terraform/salon-key.pem` and should be copied to `~/.ssh/`.
3. **Tools installed**:
   - Terraform >= 1.14
   - Ansible >= 2.14
   - jq (for JSON parsing)
   - Python 3.8+

## Configuration

### Terraform Variables

Edit `terraform/variables.tf`:

- `desired_capacity`: Number of nodes (default: 3)
- `instance_type`: EC2 instance type (default: t3.medium)
- `region`: AWS region

### Kubernetes Settings

Edit `kubespray/inventory/mycluster/group_vars/all.yml`:

- `kube_version`: Kubernetes version
- `kube_network_plugin`: CNI plugin (calico, flannel, etc.)
- `kube_pods_subnet`: Pod network CIDR

## Industry Alternatives

### 1. **Terraform + Dynamic Inventory** (This repo - ‚≠ê Recommended)

**Pros**: Separation of concerns, clear workflow, easy to debug  
**Cons**: Two-step process (Terraform ‚Üí Ansible)

### 2. **Terraform + Ansible Provisioner**

Run Ansible directly from Terraform after resource creation.

```hcl
resource "null_resource" "deploy_k8s" {
  provisioner "local-exec" {
    command = "ansible-playbook -i inventory/mycluster/hosts.yaml cluster.yml"
  }
  depends_on = [null_resource.generate_inventory]
}
```

**Pros**: Fully automated single command  
**Cons**: Tight coupling, harder to debug, Terraform not designed for config mgmt

### 3. **Pure Terraform with User Data**

Use cloud-init scripts in EC2 user_data.

**Pros**: No additional tools  
**Cons**: Limited configuration options, hard to maintain complex setups

### 4. **Managed Kubernetes (EKS, GKE, AKS)**

Use cloud provider's managed service.

**Pros**: Fully managed control plane, auto-updates  
**Cons**: Vendor lock-in, higher cost, less control

### 5. **GitOps (ArgoCD/Flux) + IaC**

Combine with GitOps for application deployments.

```
Terraform ‚Üí Infrastructure
Kubespray ‚Üí Kubernetes
ArgoCD   ‚Üí Applications
```

**Pros**: Full automation, declarative, audit trail  
**Cons**: More complexity, steeper learning curve

## Common Issues & Solutions

### Inventory not found

```bash
cd terraform && bash generate_inventory.sh
```

### SSH connection fails

- Check security group allows SSH (port 22)
- Verify SSH key path in inventory
- Check key permissions: `chmod 400 ~/.ssh/salon-key.pem`

### Ansible can't find roles

The `kubespray-defaults` role should exist in `kubespray/roles/`. If missing:

```bash
cd kubespray
ansible-galaxy install -r requirements.yml
```

### Instances not showing in data source

Wait 30-60 seconds after `terraform apply` for ASG instances to register with proper tags.

## Next Steps After Deployment

1. **Get kubeconfig**:

   ```bash
   ssh ubuntu@<master-ip> -i ~/.ssh/salon-key.pem
   sudo cat /etc/kubernetes/admin.conf
   ```

2. **Copy to local machine**:

   ```bash
   mkdir -p ~/.kube
   # Copy content from above to ~/.kube/config
   # Update server IP to master public IP
   ```

3. **Verify cluster**:
   ```bash
   kubectl get nodes
   kubectl get pods -A
   ```

## References

- [Terraform Best Practices](https://www.terraform-best-practices.com/)
- [Kubespray Documentation](https://kubespray.io/)
- [Ansible Best Practices](https://docs.ansible.com/ansible/latest/user_guide/playbooks_best_practices.html)
- [12-Factor Apps](https://12factor.net/)

## License

MIT

## DevOps & Infrastructure Snapshot

Below is a summary of the DevOps components currently configured in this repository, extracted from the living system explorer.

### üèóÔ∏è Infrastructure as Code
**Terraform** manages the AWS foundation:
- **VPC:** Dedicated isolated network with Public/Private subnets.
- **Security:** Tight Security Groups (only ALB public).
- **Databases:** Managed RDS and MSK (Kafka) clusters.
- **Automation:** `deploy-k8s.sh` orchestrates Terraform apply.

### ‚ò∏Ô∏è Kubernetes Provisioning
**Kubespray (Ansible)** bootstraps the K8s cluster:
- **Inventory:** Dynamic Python script generates inventory from Terraform output.
- **Playbooks:** Installs Docker/Containerd, Kubelet, Kube-Proxy, and Networking (Calico).
- **HA:** Supports multi-control plane setup for high availability.

### üîÑ GitOps & CD
**ArgoCD** acts as the continuous delivery controller:
- **App of Apps:** Manages Staging and Production environments as separate applications.
- **Sync Policy:** Automatic sync ensures cluster state matches git `main` branch.
- **Bootstrap:** `bootstrap.sh` installs ArgoCD, applies namespaces, and registers apps.

### ü§ñ CI Pipelines
**GitHub Actions** handles integration:
- **Pull Requests:** Runs unit tests (Pytest) and linters.
- **Merge:** Builds Docker images, pushes to ECR, and updates Helm/Kustomize manifests.

### Key Automation Scripts
| Script | Role | Location |
| :--- | :--- | :--- |
| `deploy-k8s.sh` | Full infrastructure & cluster bring-up | `salon-k8s-infra/` |
| `bootstrap.sh` | Installs ArgoCD & applies GitOps apps | `salon-gitops/` |
| `refresh-inventory.sh` | Updates Ansible inventory from TF state | `salon-k8s-infra/` |
